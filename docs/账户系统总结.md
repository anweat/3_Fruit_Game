# è´¦æˆ·ç³»ç»Ÿæ€»ç»“

## ğŸ“… æ›´æ–°æ—¶é—´
2025-12-14

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

è´¦æˆ·ç³»ç»Ÿæä¾›ç©å®¶èº«ä»½ç®¡ç†ã€æ•°æ®æŒä¹…åŒ–å’Œå¤šè´¦æˆ·æ”¯æŒåŠŸèƒ½ã€‚åŸºäº SQLite æ•°æ®åº“ï¼Œæ”¯æŒæ³¨å†Œè´¦æˆ·å’Œæ¸¸å®¢æ¨¡å¼ä¸¤ç§ç™»å½•æ–¹å¼ã€‚

---

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | æ–‡ä»¶ |
|------|------|------|
| `LoginWidget` | ç™»å½•ç•Œé¢ UI | `ui/LoginWidget.h/cpp` |
| `Database` | æ•°æ®æŒä¹…åŒ–å•ä¾‹ | `src/data/Database.h/cpp` |
| `MainWindow` | ä¸»çª—å£çŠ¶æ€ç®¡ç† | `ui/MainWindow.h/cpp` |

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LoginWidget                â”‚
â”‚         (ç™»å½•/æ³¨å†Œ/æ¸¸å®¢ç•Œé¢)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ loginSucceeded(playerId, playerName)
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MainWindow                 â”‚
â”‚    initAchievementSystemForPlayer()     â”‚
â”‚         showMainMenu()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database  â”‚    â”‚ AchievementMgr â”‚
â”‚  (SQLite)  â”‚    â”‚ (æˆå°±ç³»ç»Ÿ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ç™»å½•æµç¨‹

### 1. æ³¨å†Œè´¦æˆ·ç™»å½•

```cpp
// LoginWidget::performLogin()
PlayerData player = Database::instance().getPlayer(playerId);

if (player.playerId.isEmpty()) {
    // ç©å®¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è´¦æˆ·
    if (playerName.isEmpty()) {
        // é”™è¯¯ï¼šæ–°è´¦æˆ·å¿…é¡»æä¾›åç§°
        return false;
    }
    Database::instance().createPlayer(playerId, playerName);
    Database::instance().initializeAchievements(playerId);
} else {
    // ç©å®¶å·²å­˜åœ¨ï¼ŒåŠ è½½æ•°æ®
    currentPlayerScore_ = Database::instance().getPlayerScore(playerId);
}
```

### 2. æ¸¸å®¢æ¨¡å¼

```cpp
// LoginWidget::onGuestClicked()
currentPlayerId_ = "guest";
currentPlayerName_ = "æ¸¸å®¢";
currentPlayerScore_ = 0;
emit loginSucceeded("guest", "æ¸¸å®¢");
```

**æ¸¸å®¢æ¨¡å¼ç‰¹ç‚¹ï¼š**
- âœ… å¯ä»¥æ­£å¸¸æ¸¸ç©
- âœ… æˆå°±æ£€æµ‹æ­£å¸¸
- âŒ æ•°æ®ä¸ä¿å­˜åˆ°æ•°æ®åº“
- âŒ é€€å‡ºåæ•°æ®ä¸¢å¤±
- ğŸ”¢ é“å…·é»˜è®¤ (3, 3, 3)

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### ç©å®¶è¡¨ (players)

```sql
CREATE TABLE players (
    player_id TEXT PRIMARY KEY,      -- ç©å®¶å”¯ä¸€ID
    username TEXT NOT NULL,          -- ç©å®¶åç§°
    total_points INTEGER DEFAULT 0,  -- æ€»ç‚¹æ•°ï¼ˆä¼‘é—²æ¨¡å¼ç´¯ç§¯ï¼‰
    hammer_count INTEGER DEFAULT 3,  -- é”¤å­æ•°é‡
    clamp_count INTEGER DEFAULT 3,   -- å¤¹å­æ•°é‡
    magic_wand_count INTEGER DEFAULT 3, -- é­”æ£’æ•°é‡
    created_at TEXT NOT NULL,        -- åˆ›å»ºæ—¶é—´ (ISO8601)
    last_login TEXT NOT NULL         -- æœ€åç™»å½•æ—¶é—´
);
```

### æˆå°±è¿›åº¦è¡¨ (achievement_progress)

```sql
CREATE TABLE achievement_progress (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    player_id TEXT NOT NULL,         -- ç©å®¶ID (å¤–é”®)
    achievement_id TEXT NOT NULL,    -- æˆå°±ID
    current_value INTEGER DEFAULT 0, -- å½“å‰è¿›åº¦
    target_value INTEGER NOT NULL,   -- ç›®æ ‡å€¼
    state INTEGER DEFAULT 0,         -- çŠ¶æ€ (0:æœªå®Œæˆ, 1:å·²å®Œæˆ, 2:å·²é¢†å–)
    completed_at TEXT,               -- å®Œæˆæ—¶é—´
    UNIQUE(player_id, achievement_id)
);
```

### æ¸¸æˆè®°å½•è¡¨ (game_records)

```sql
CREATE TABLE game_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    player_id TEXT NOT NULL,
    mode TEXT NOT NULL,              -- "Casual" æˆ– "Competition"
    score INTEGER NOT NULL,
    max_combo INTEGER DEFAULT 0,
    played_at TEXT NOT NULL
);
```

---

## ğŸ”§ Database API

### ç©å®¶æ•°æ®æ“ä½œ

```cpp
// åˆ›å»ºç©å®¶
bool createPlayer(const QString& playerId, const QString& username);

// è·å–ç©å®¶ï¼ˆä¸å­˜åœ¨è¿”å›ç©º PlayerDataï¼‰
PlayerData getPlayer(const QString& playerId);

// è·å–/ä¿å­˜åˆ†æ•°
int getPlayerScore(const QString& playerId);
bool savePlayerScore(const QString& playerId, int score);

// è·å–/ä¿å­˜é“å…·
PropData getPlayerProps(const QString& playerId);
bool savePlayerProps(const QString& playerId, int hammer, int clamp, int magicWand);
```

### å½“å‰ç©å®¶ç®¡ç†

```cpp
// è·å–/è®¾ç½®å½“å‰ä¼šè¯ç©å®¶ID
QString getCurrentPlayerId() const;
void setCurrentPlayerId(const QString& playerId);
```

---

## ğŸ“± UI ç»„ä»¶

### LoginWidget ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ğŸ æ°´æœæ¶ˆæ¶ˆä¹               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç©å®¶ID: [___________________]      â”‚
â”‚                                     â”‚
â”‚  ç©å®¶åç§°: [___________________]    â”‚
â”‚  (æ–°è´¦æˆ·éœ€è¦å¡«å†™)                    â”‚
â”‚                                     â”‚
â”‚  [    ç™»å½•    ]  [  æ¸¸å®¢æ¨¡å¼  ]     â”‚
â”‚                                     â”‚
â”‚  çŠ¶æ€: _______________              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç™»å½•åç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ ç©å®¶: Alice                     â”‚
â”‚  ğŸ’° åˆ†æ•°: 12,340                    â”‚
â”‚                                     â”‚
â”‚  [    ç™»å‡º    ]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµ

### ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥ playerId + playerName
    â†“
ç‚¹å‡»ç™»å½•æŒ‰é’®
    â†“
performLogin(playerId, playerName)
    â†“
Database::getPlayer(playerId)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç©å®¶å­˜åœ¨?                           â”‚
â”‚   æ˜¯ â†’ åŠ è½½ç°æœ‰æ•°æ®                  â”‚
â”‚   å¦ â†’ åˆ›å»ºæ–°ç©å®¶ + åˆå§‹åŒ–æˆå°±        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
emit loginSucceeded(playerId, playerName)
    â†“
MainWindow::initAchievementSystemForPlayer(playerId)
    â†“
AchievementManager::setCurrentPlayerId(playerId)
Database::setCurrentPlayerId(playerId)
    â†“
showMainMenu()
```

### æ¸¸æˆæ•°æ®ä¿å­˜æµç¨‹

```
æ¸¸æˆè¿›è¡Œä¸­...
    â†“
è¿”å›èœå• / å…³é—­ç¨‹åº
    â†“
GameEngine::endGameSession()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if (playerId != "guest") {          â”‚
â”‚   savePlayerScore(playerId, score); â”‚
â”‚   savePlayerProps(playerId, ...);   â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ å¤šè´¦æˆ·æ”¯æŒ

### è´¦æˆ·åˆ‡æ¢æµç¨‹

```cpp
// 1. ç”¨æˆ·ç‚¹å‡»ç™»å‡º
void MainWindow::logout() {
    // ä¿å­˜å½“å‰æ¸¸æˆæ•°æ®
    if (gameEngine_ && currentPlayerId_ != "guest") {
        gameEngine_->endGameSession();
    }
    
    // é‡ç½®çŠ¶æ€
    loginWidget_->resetLoginState();
    showLoginWidget();
}

// 2. ç”¨æˆ·é‡æ–°ç™»å½•
void MainWindow::initAchievementSystemForPlayer(playerId) {
    currentPlayerId_ = playerId;
    
    // é€šçŸ¥æˆå°±ç³»ç»Ÿåˆ‡æ¢ç©å®¶
    AchievementManager::instance().setCurrentPlayerId(playerId);
    
    // è®¾ç½®æ•°æ®åº“å½“å‰ç©å®¶
    Database::instance().setCurrentPlayerId(playerId);
}
```

### æ•°æ®éš”ç¦»ä¿è¯

| æ•°æ®ç±»å‹ | éš”ç¦»æ–¹å¼ |
|----------|----------|
| åˆ†æ•° | `players.total_points` æŒ‰ `player_id` |
| é“å…· | `players.hammer/clamp/magic_wand_count` |
| æˆå°±è¿›åº¦ | `achievement_progress` æŒ‰ `player_id` |
| æ¸¸æˆè®°å½• | `game_records` æŒ‰ `player_id` |

---

## âš ï¸ å…³é”®ä¿®å¤è®°å½•

### 1. getPlayer è¿”å›å€¼é—®é¢˜

**é—®é¢˜**: åŸæ¥åœ¨å‡½æ•°å¼€å¤´å°±è®¾ç½® `data.playerId = playerId`ï¼Œå¯¼è‡´æ°¸è¿œè¿”å›éç©ºå¯¹è±¡

**ä¿®å¤**:
```cpp
PlayerData Database::getPlayer(const QString& playerId) {
    PlayerData data;
    // playerId åˆå§‹ä¸ºç©ºï¼Œåªæœ‰åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°æ—¶æ‰è®¾ç½®
    
    if (query.next()) {
        data.playerId = query.value(0).toString();  // æ‰¾åˆ°æ‰è®¾ç½®
        // ...
    }
    return data;
}
```

### 2. æˆå°±ç³»ç»Ÿç©å®¶IDæœªåŒæ­¥

**é—®é¢˜**: `MilestoneAchievementDetector` ä¸­çš„ `currentPlayerId_` åœ¨åˆ‡æ¢è´¦å·åä»ä¸ºæ—§å€¼

**ä¿®å¤**:
```cpp
void AchievementWorker::setCurrentPlayerId(const QString& playerId) {
    currentPlayerId_ = playerId;
    triggeredThisSession_.clear();
    cumulativeStats_ = CumulativeStats();
    
    // å…³é”®ï¼šæ›´æ–°æ‰€æœ‰æ£€æµ‹å™¨ä¸­çš„ç©å®¶ID
    DetectorFactory::registerPlayerStats(detectorManager_, currentPlayerId_, ...);
}
```

### 3. é“å…·æ•°æ®æŒä¹…åŒ–

**æ–°å¢åŠŸèƒ½**:
```cpp
// Database.h
struct PropData {
    int hammerCount = 3;
    int clampCount = 3;
    int magicWandCount = 3;
};

PropData getPlayerProps(const QString& playerId);
bool savePlayerProps(const QString& playerId, int hammer, int clamp, int magicWand);
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ui/LoginWidget.h/cpp` | ç™»å½•ç•Œé¢ç»„ä»¶ |
| `ui/MainWindow.h/cpp` | ä¸»çª—å£ï¼Œç®¡ç†é¡µé¢åˆ‡æ¢ |
| `src/data/Database.h/cpp` | æ•°æ®åº“æ“ä½œå•ä¾‹ |
| `src/achievement/AchievementManager.cpp` | æˆå°±ç³»ç»Ÿç©å®¶åˆ‡æ¢ |

---

## âœ… åŠŸèƒ½æ¸…å•

- [x] æ³¨å†Œè´¦æˆ·ç™»å½•
- [x] æ¸¸å®¢æ¨¡å¼
- [x] åˆ†æ•°æŒä¹…åŒ–ï¼ˆä¼‘é—²æ¨¡å¼ç´¯ç§¯ï¼‰
- [x] é“å…·æŒä¹…åŒ–
- [x] æˆå°±è¿›åº¦æŒä¹…åŒ–
- [x] å¤šè´¦æˆ·æ•°æ®éš”ç¦»
- [x] è´¦æˆ·åˆ‡æ¢
- [x] ç™»å‡ºåŠŸèƒ½
