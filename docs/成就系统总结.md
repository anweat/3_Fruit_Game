# æˆå°±ç³»ç»Ÿæ€»ç»“

## ğŸ“… æ›´æ–°æ—¶é—´
2025-12-14

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

æˆå°±ç³»ç»Ÿæ˜¯ä¸€ä¸ªæ¨¡å—åŒ–ã€å¤šçº¿ç¨‹ã€æ˜“äºæ‰©å±•çš„æ¡†æ¶ï¼Œç”¨äºæ£€æµ‹å’Œç®¡ç†æ¸¸æˆä¸­çš„ **62 ä¸ªæˆå°±**ã€‚é‡‡ç”¨ç­–ç•¥æ¨¡å¼å°†æ£€æµ‹é€»è¾‘åˆ†ç¦»æˆ **8 ä¸ªç‹¬ç«‹æ£€æµ‹å™¨**ï¼Œå®ç°é«˜å¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | çº¿ç¨‹ |
|------|------|------|
| `AchievementManager` | å•ä¾‹ç®¡ç†å™¨ï¼Œåè°ƒæˆå°±ç³»ç»Ÿ | ä¸»çº¿ç¨‹ |
| `AchievementWorker` | æˆå°±æ£€æµ‹ä¸æ•°æ®åº“äº¤äº’ | å·¥ä½œçº¿ç¨‹ |
| `AchievementDetectorManager` | ç®¡ç†æ‰€æœ‰æ£€æµ‹å™¨ | å·¥ä½œçº¿ç¨‹ |
| `DetectorFactory` | åˆ›å»ºå’Œåˆå§‹åŒ–æ£€æµ‹å™¨ | - |
| `Database` | æˆå°±è¿›åº¦æŒä¹…åŒ– | ä¸»çº¿ç¨‹ |

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            GameEngine                   â”‚
â”‚    (æ¸¸æˆé€»è¾‘ï¼Œå‘é€ GameDataSnapshot)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ recordGameSnapshot()
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AchievementManager              â”‚
â”‚      (ä¸»çº¿ç¨‹ï¼Œè½¬å‘æ•°æ®åˆ°å·¥ä½œçº¿ç¨‹)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ emit gameDataReceived()
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AchievementWorker               â”‚
â”‚      (å·¥ä½œçº¿ç¨‹ï¼Œæ‰§è¡Œæˆå°±æ£€æµ‹)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ detectAll()
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AchievementDetectorManager            â”‚
â”‚      (ç®¡ç† 8 ä¸ªæ£€æµ‹å™¨)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“          â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆçº§   â”‚ è¿å‡»   â”‚ å¤šæ¶ˆ   â”‚ ç‰¹æ®Š   â”‚
â”‚ 3ä¸ª    â”‚ 7ä¸ª    â”‚ 10ä¸ª   â”‚ 10ä¸ª   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†æ•°   â”‚ é“å…·   â”‚ æŒ‘æˆ˜   â”‚ é‡Œç¨‹ç¢‘ â”‚
â”‚ 8ä¸ª    â”‚ 6ä¸ª    â”‚ 6ä¸ª    â”‚ 8ä¸ª    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ–ï¸ æˆå°±åˆ†ç±» (62ä¸ª)

| æ£€æµ‹å™¨ | æˆå°±ç±»åˆ« | æ•°é‡ | ç¤ºä¾‹ |
|--------|----------|------|------|
| `BeginnerAchievementDetector` | åˆçº§æˆå°± | 3 | åˆæ¥ä¹åˆ°ã€é¦–æ¬¡æ¶ˆé™¤ |
| `ComboAchievementDetector` | è¿å‡»æˆå°± | 7 | 3/5/8/12/15è¿å‡» |
| `MultiMatchAchievementDetector` | å¤šæ¶ˆæˆå°± | 10 | 4/5/6/8æ¶ˆ |
| `SpecialAchievementDetector` | ç‰¹æ®Šå…ƒç´  | 10 | ç”Ÿæˆ/ä½¿ç”¨ç‰¹æ®Šæ°´æœ |
| `ScoreAchievementDetector` | åˆ†æ•°æˆå°± | 8 | 100/1k/5k/10k/100kåˆ† |
| `PropAchievementDetector` | é“å…·æˆå°± | 6 | é¦–æ¬¡ä½¿ç”¨é”¤å­/å¤¹å­/é­”æ£’ |
| `ChallengeAchievementDetector` | æŒ‘æˆ˜æˆå°± | 6 | é™æ—¶æŒ‘æˆ˜ã€å®Œç¾å¼€å±€ |
| `MilestoneAchievementDetector` | é‡Œç¨‹ç¢‘ | 8 | æ¸¸æˆå±€æ•°ã€ç‚¹æ•°å¯Œç¿ |

---

## ğŸ“Š æ•°æ®æµ

### GameDataSnapshot ç»“æ„

```cpp
struct GameDataSnapshot {
    // å•å±€æ•°æ®
    int currentScore;           // å½“å‰å¾—åˆ†
    int currentCombo;           // å½“å‰è¿å‡»
    int maxCombo;               // æœ€å¤§è¿å‡»
    QString gameMode;           // æ¸¸æˆæ¨¡å¼
    qint64 gameStartTime;       // æ¸¸æˆå¼€å§‹æ—¶é—´
    
    // æœ¬æ¬¡æ¶ˆé™¤æ•°æ®
    int lastMatchSize;          // æœ¬æ¬¡æ¶ˆé™¤æ•°é‡
    int lastMatchElementType;   // æ¶ˆé™¤çš„å…ƒç´ ç±»å‹
    bool lastMatchSameElement;  // æ˜¯å¦å…¨ä¸ºç›¸åŒå…ƒç´ 
    
    // ç‰¹æ®Šå…ƒç´ /é“å…·
    QString specialGenerated;   // ç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ 
    QString propUsedType;       // ä½¿ç”¨çš„é“å…·ç±»å‹
    
    // ç»Ÿè®¡
    int match4Count, match5Count, match6Count;
    QSet<int> fruitTypesEliminated;
};
```

### æ£€æµ‹æµç¨‹

```
æ¸¸æˆæ¶ˆé™¤å‘ç”Ÿ
    â†“
GameEngine æ„å»º GameDataSnapshot
    â†“
recordGameSnapshot(snapshot)  [ä¸»çº¿ç¨‹]
    â†“
emit gameDataReceived(snapshot)
    â†“
onGameDataReceived(snapshot)  [å·¥ä½œçº¿ç¨‹]
    â†“
checkAllAchievements(snapshot)
    â†“
detectorManager_->detectAll(snapshot, callback)
    â†“
æ¯ä¸ªæ£€æµ‹å™¨è°ƒç”¨ callback(achievementId, currentValue, targetValue)
    â†“
updateProgress() â†’ æ£€æŸ¥ç¼“å­˜ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ æ›´æ–°è¿›åº¦ â†’ å®Œæˆæ£€æµ‹
    â†“
å¦‚æœå®Œæˆ â†’ notifyUnlock() â†’ emit achievementUnlocked()
    â†“
handleAchievementUnlocked() â†’ è°ƒç”¨ UI å›è°ƒæ˜¾ç¤ºé€šçŸ¥
```

---

## ğŸ” é˜²é‡å¤è§¦å‘æœºåˆ¶

### ä¸‰é‡ä¿æŠ¤

1. **ä¼šè¯ç¼“å­˜** (`triggeredThisSession_`)
   - å·²è§¦å‘çš„æˆå°±åœ¨æœ¬æ¬¡æ¸¸æˆä¼šè¯å†…ä¸å†æ£€æµ‹
   - æ¯æ¬¡ `onGameStarted()` æ—¶ä»æ•°æ®åº“åŠ è½½å·²å®Œæˆæˆå°±

2. **æ•°æ®åº“çŠ¶æ€æ£€æŸ¥**
   - `CLAIMED` çŠ¶æ€ï¼šç›´æ¥è·³è¿‡
   - `COMPLETED` çŠ¶æ€ï¼šåŠ å…¥ç¼“å­˜åè·³è¿‡

3. **è¿›åº¦æ¯”è¾ƒ**
   - åªæœ‰å½“ `currentValue > progress.currentValue` æ—¶æ‰æ›´æ–°

### çŠ¶æ€æšä¸¾

```cpp
enum class AchievementState {
    LOCKED = 0,      // æœªå®Œæˆ
    COMPLETED = 1,   // å·²å®Œæˆä½†æœªé¢†å–å¥–åŠ±
    CLAIMED = 2      // å·²é¢†å–å¥–åŠ±
};
```

---

## ğŸ æˆå°±å¥–åŠ±

æˆå°±å®Œæˆåè‡ªåŠ¨å°†å¥–åŠ±åˆ†æ•°åŠ å…¥æ¸¸æˆï¼š

```cpp
// AchievementWorker::notifyUnlock()
if (gameEngine_ && def.reward > 0) {
    gameEngine_->addScore(def.reward);
}
```

| ç¨€æœ‰åº¦ | å¥–åŠ±åˆ†æ•°èŒƒå›´ |
|--------|-------------|
| COMMON | 5-20 |
| RARE | 30-50 |
| EPIC | 100-200 |
| LEGENDARY | 300-500 |
| DIAMOND | 1000 |

---

## ğŸ‘¥ å¤šè´¦æˆ·æ”¯æŒ

### ç©å®¶åˆ‡æ¢æµç¨‹

```cpp
// MainWindow::initAchievementSystemForPlayer()
AchievementManager::instance().setCurrentPlayerId(playerId);

// AchievementWorker::setCurrentPlayerId()
currentPlayerId_ = playerId;
triggeredThisSession_.clear();      // æ¸…ç©ºä¼šè¯ç¼“å­˜
cumulativeStats_ = CumulativeStats(); // é‡ç½®ç´¯è®¡ç»Ÿè®¡
DetectorFactory::registerPlayerStats(...); // æ›´æ–°æ£€æµ‹å™¨ä¸­çš„ç©å®¶ID
```

### æ•°æ®éš”ç¦»

- æ¯ä¸ªç©å®¶åœ¨ `achievement_progress` è¡¨ä¸­æœ‰ç‹¬ç«‹çš„æˆå°±è®°å½•
- ä¸»é”®ï¼š`(player_id, achievement_id)` ç»„åˆå”¯ä¸€
- åˆ‡æ¢è´¦å·æ—¶è‡ªåŠ¨åŠ è½½å¯¹åº”ç©å®¶çš„æˆå°±æ•°æ®

---

## ğŸ® æ¸¸å®¢æ¨¡å¼

æ¸¸å®¢æ¨¡å¼ä¸‹æˆå°±ç³»ç»Ÿçš„ç‰¹æ®Šå¤„ç†ï¼š

```cpp
if (currentPlayerId_ == "guest") {
    // ä¸è®¿é—®æ•°æ®åº“ï¼Œä½¿ç”¨å†…å­˜çŠ¶æ€
    if (currentValue >= targetValue) {
        triggeredThisSession_.insert(achievementId);
        notifyUnlock(achievementId);
    }
    return;
}
```

- âœ… æˆå°±æ£€æµ‹æ­£å¸¸å·¥ä½œ
- âœ… æˆå°±é€šçŸ¥æ­£å¸¸æ˜¾ç¤º
- âŒ æˆå°±è¿›åº¦ä¸ä¿å­˜åˆ°æ•°æ®åº“
- âŒ é€€å‡ºåæˆå°±æ•°æ®ä¸¢å¤±

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/achievement/AchievementManager.h/cpp` | æˆå°±ç®¡ç†å™¨ä¸»ç±» |
| `src/achievement/AchievementDef.h` | æˆå°±å®šä¹‰ç»“æ„ |
| `src/achievement/detectors/` | 8ä¸ªæ£€æµ‹å™¨å®ç° |
| `src/data/Database.cpp` | æˆå°±æ•°æ®åº“æ“ä½œ |

---

## âœ… å·²ä¿®å¤é—®é¢˜

1. **å¤šæ¶ˆç›¸åŒå…ƒç´ æ£€æµ‹** - åªæœ‰å…¨ç›¸åŒå…ƒç´ æ‰è®¡ä¸º N æ¶ˆæˆå°±
2. **æˆå°±å¥–åŠ±åˆ†æ•°** - è‡ªåŠ¨åŠ å…¥æ¸¸æˆåˆ†æ•°
3. **ä¼‘é—²æ¨¡å¼åˆ†æ•°æŒä¹…åŒ–** - è·¨ä¼šè¯ç´¯ç§¯
4. **ä¼šè¯å†…é‡å¤è§¦å‘** - ä»æ•°æ®åº“é¢„åŠ è½½å·²å®Œæˆæˆå°±
5. **å¤šè´¦æˆ·æˆå°±éš”ç¦»** - åˆ‡æ¢è´¦å·æ—¶æ¸…ç©ºç¼“å­˜å¹¶æ›´æ–°æ£€æµ‹å™¨
