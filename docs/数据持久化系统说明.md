# æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿè¯´æ˜

## ğŸ“… åˆ›å»ºæ—¶é—´
2025-12-14

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

åŸºäºSQLiteçš„æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿï¼Œè´Ÿè´£ç®¡ç†ç©å®¶æ•°æ®ã€æˆå°±è¿›åº¦å’Œæ¸¸æˆè®°å½•ã€‚

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. ç©å®¶è¡¨ (players)

å­˜å‚¨ç©å®¶çš„åŸºç¡€ä¿¡æ¯ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| player_id | TEXT | ç©å®¶å”¯ä¸€ID | ä¸»é”® |
| username | TEXT | ç©å®¶åç§° | NOT NULL |
| total_points | INTEGER | æ€»ç‚¹æ•° | DEFAULT 0 |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ | NOT NULL (ISO8601) |
| last_login | TEXT | æœ€åç™»å½•æ—¶é—´ | NOT NULL (ISO8601) |

**è¯´æ˜**ï¼š
- `player_id`ï¼šå½“å‰é»˜è®¤ä¸º `"admin"`ï¼Œæœªæ¥å¯æ‰©å±•ä¸ºä¼šè¯çº§éšæœºID
- `total_points`ï¼šé€šè¿‡å®Œæˆæˆå°±ç´¯ç§¯çš„ç‚¹æ•°

---

### 2. æˆå°±è¿›åº¦è¡¨ (achievement_progress)

è·Ÿè¸ªç©å®¶çš„æˆå°±è§£é”è¿›åº¦ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | INTEGER | è‡ªå¢ID | ä¸»é”® |
| player_id | TEXT | ç©å®¶ID | å¤–é”® â†’ players.player_id |
| achievement_id | TEXT | æˆå°±ID | å¯¹åº” AchievementDef::id |
| current_value | INTEGER | å½“å‰è¿›åº¦å€¼ | DEFAULT 0 |
| target_value | INTEGER | ç›®æ ‡å€¼ | NOT NULL |
| state | INTEGER | å®ŒæˆçŠ¶æ€ | 0/1/2 (è§ä¸‹æ–¹è¯´æ˜) |
| completed_at | TEXT | å®Œæˆæ—¶é—´ | ISO8601 (å¯ä¸ºç©º) |

**æˆå°±çŠ¶æ€æšä¸¾ (AchievementState)**ï¼š
```cpp
enum class AchievementState {
    LOCKED = 0,      // æœªå®Œæˆ
    COMPLETED = 1,   // å·²å®Œæˆä½†æœªé¢†å–å¥–åŠ±
    CLAIMED = 2      // å·²é¢†å–å¥–åŠ±
};
```

**å”¯ä¸€æ€§çº¦æŸ**ï¼š`(player_id, achievement_id)` ç»„åˆå”¯ä¸€

---

### 3. æ¸¸æˆè®°å½•è¡¨ (game_records)

è®°å½•æ¯ä¸€å±€æ¸¸æˆçš„è¯¦ç»†æ•°æ®ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|------|------|------|------|
| id | INTEGER | è‡ªå¢ID | ä¸»é”® |
| player_id | TEXT | ç©å®¶ID | å¤–é”® â†’ players.player_id |
| mode | TEXT | æ¸¸æˆæ¨¡å¼ | "Casual" æˆ– "Competition" |
| score | INTEGER | æœ¬å±€å¾—åˆ† | NOT NULL |
| max_combo | INTEGER | æœ€å¤§è¿å‡»æ•° | DEFAULT 0 |
| played_at | TEXT | æ¸¸æˆæ—¶é—´ | NOT NULL (ISO8601) |

**ç´¢å¼•ä¼˜åŒ–**ï¼š
- `idx_achievement_player`ï¼šåŠ é€Ÿæˆå°±è¿›åº¦æŸ¥è¯¢
- `idx_game_records_player`ï¼šåŠ é€Ÿæ¸¸æˆè®°å½•æŸ¥è¯¢

---

## ğŸ”§ API ä½¿ç”¨æŒ‡å—

### åˆå§‹åŒ–æ•°æ®åº“

```cpp
#include "src/data/Database.h"

// åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–
bool success = Database::instance().initialize("fruitcrush.db");
if (!success) {
    qCritical() << "æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼";
    return -1;
}
```

**é»˜è®¤è¡Œä¸º**ï¼š
- è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- è‡ªåŠ¨åˆ›å»ºé»˜è®¤ç©å®¶ `"admin"`
- è‡ªåŠ¨åˆå§‹åŒ–æˆå°±æ•°æ®ï¼ˆå¾…AchievementManagerå®Œå–„ï¼‰

---

### ç©å®¶æ•°æ®æ“ä½œ

#### 1. è·å–å½“å‰ç©å®¶ä¿¡æ¯

```cpp
QString playerId = Database::instance().getCurrentPlayerId(); // "admin"
PlayerData player = Database::instance().getPlayer(playerId);

qDebug() << "ç©å®¶åç§°ï¼š" << player.username;
qDebug() << "æ€»ç‚¹æ•°ï¼š" << player.totalPoints;
qDebug() << "åˆ›å»ºæ—¶é—´ï¼š" << player.createdAt;
```

#### 2. æ›´æ–°ç©å®¶ç‚¹æ•°ï¼ˆå¢é‡ï¼‰

```cpp
// å®Œæˆæˆå°±åå¢åŠ ç‚¹æ•°
bool success = Database::instance().updatePlayerPoints("admin", 50);
// player.total_points += 50
```

#### 3. æ›´æ–°æœ€åç™»å½•æ—¶é—´

```cpp
Database::instance().updateLastLogin("admin");
```

---

### æˆå°±è¿›åº¦æ“ä½œ

#### 1. è·å–å•ä¸ªæˆå°±è¿›åº¦

```cpp
AchievementProgress progress = Database::instance()
    .getAchievementProgress("admin", "ach_first_match");

qDebug() << "å½“å‰è¿›åº¦ï¼š" << progress.currentValue 
         << "/" << progress.targetValue;
qDebug() << "çŠ¶æ€ï¼š" << static_cast<int>(progress.state);
```

#### 2. è·å–æ‰€æœ‰æˆå°±è¿›åº¦

```cpp
QList<AchievementProgress> allProgress = Database::instance()
    .getAllAchievementProgress("admin");

for (const auto& progress : allProgress) {
    qDebug() << progress.achievementId 
             << "è¿›åº¦ï¼š" << progress.currentValue;
}
```

#### 3. æ›´æ–°æˆå°±è¿›åº¦

```cpp
// ä¾‹å¦‚ï¼šå®Œæˆä¸€æ¬¡ä¸‰æ¶ˆï¼Œæ›´æ–°"ä¸‰æ¶ˆè¾¾äºº"æˆå°±
Database::instance().updateAchievementProgress(
    "admin", 
    "ach_match3_master", 
    50  // å½“å‰å®Œæˆäº†50æ¬¡ä¸‰æ¶ˆ
);
```

#### 4. å®Œæˆæˆå°±

```cpp
// å½“è¿›åº¦è¾¾åˆ°ç›®æ ‡å€¼æ—¶ï¼Œæ ‡è®°æˆå°±ä¸ºå·²å®Œæˆ
Database::instance().completeAchievement("admin", "ach_match3_master");
// state: LOCKED â†’ COMPLETED
```

#### 5. é¢†å–æˆå°±å¥–åŠ±

```cpp
// ç©å®¶ç‚¹å‡»"é¢†å–å¥–åŠ±"æŒ‰é’®
int reward = 50; // ä»AchievementDefè·å–
bool success = Database::instance().claimAchievementReward(
    "admin", 
    "ach_match3_master", 
    reward
);

// âœ… è‡ªåŠ¨å®Œæˆä¸¤ä¸ªæ“ä½œï¼ˆäº‹åŠ¡ä¿è¯åŸå­æ€§ï¼‰ï¼š
// 1. state: COMPLETED â†’ CLAIMED
// 2. total_points += reward
```

---

### æ¸¸æˆè®°å½•æ“ä½œ

#### 1. ä¿å­˜æ¸¸æˆè®°å½•

```cpp
// æ¸¸æˆç»“æŸæ—¶ä¿å­˜è®°å½•
GameRecord record;
record.playerId = "admin";
record.mode = "Casual";  // æˆ– "Competition"
record.score = 1580;
record.maxCombo = 12;
record.playedAt = QDateTime::currentDateTime();

Database::instance().saveGameRecord(record);
```

#### 2. è·å–æ¸¸æˆå†å²

```cpp
// è·å–æœ€è¿‘10æ¡æ¸¸æˆè®°å½•
QList<GameRecord> records = Database::instance()
    .getGameRecords("admin", 10);

for (const auto& rec : records) {
    qDebug() << rec.playedAt.toString() 
             << "å¾—åˆ†ï¼š" << rec.score;
}
```

---

### ç»Ÿè®¡æŸ¥è¯¢

#### 1. è·å–æ€»æ¸¸æˆå±€æ•°

```cpp
int totalGames = Database::instance().getTotalGamesPlayed("admin");
qDebug() << "æ€»å…±ç©äº†" << totalGames << "å±€æ¸¸æˆ";
```

#### 2. è·å–æœ€é«˜åˆ†

```cpp
int highScore = Database::instance().getHighestScore("admin");
qDebug() << "å†å²æœ€é«˜åˆ†ï¼š" << highScore;
```

#### 3. è·å–å·²å®Œæˆæˆå°±æ•°

```cpp
int completedCount = Database::instance()
    .getCompletedAchievementCount("admin");
qDebug() << "å·²å®Œæˆ" << completedCount << "ä¸ªæˆå°±";
```

---

## ğŸ”„ æ•°æ®æµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šç©å®¶å®Œæˆä¸€å±€æ¸¸æˆ

```cpp
// 1. ä¿å­˜æ¸¸æˆè®°å½•
GameRecord record;
record.playerId = Database::instance().getCurrentPlayerId();
record.mode = "Casual";
record.score = finalScore;
record.maxCombo = maxComboCount;
record.playedAt = QDateTime::currentDateTime();
Database::instance().saveGameRecord(record);

// 2. æ›´æ–°ç›¸å…³æˆå°±è¿›åº¦
// ï¼ˆç”±AchievementManagerç›‘å¬æ¸¸æˆç»“æŸäº‹ä»¶è§¦å‘ï¼‰
// ä¾‹å¦‚ï¼š"æ–°æ‰‹ä¸Šè·¯" æˆå°±ï¼ˆå®Œæˆ1å±€æ¸¸æˆï¼‰
AchievementProgress progress = Database::instance()
    .getAchievementProgress("admin", "ach_first_game");

if (progress.state == AchievementState::LOCKED) {
    Database::instance().updateAchievementProgress(
        "admin", 
        "ach_first_game", 
        1  // å·²å®Œæˆ1å±€
    );
    
    // æ£€æŸ¥æ˜¯å¦è¾¾æˆ
    if (1 >= progress.targetValue) {
        Database::instance().completeAchievement("admin", "ach_first_game");
        // å¼¹å‡ºæˆå°±è§£é”é€šçŸ¥
    }
}
```

### åœºæ™¯2ï¼šç©å®¶åœ¨æˆå°±ç•Œé¢é¢†å–å¥–åŠ±

```cpp
// ç©å®¶ç‚¹å‡»"é¢†å–"æŒ‰é’®
QString achievementId = "ach_first_game";
int reward = 10; // ä»AchievementDefè·å–

// æ£€æŸ¥çŠ¶æ€
AchievementProgress progress = Database::instance()
    .getAchievementProgress("admin", achievementId);

if (progress.state == AchievementState::COMPLETED) {
    // é¢†å–å¥–åŠ±
    bool success = Database::instance().claimAchievementReward(
        "admin", 
        achievementId, 
        reward
    );
    
    if (success) {
        // æ›´æ–°UIæ˜¾ç¤ºç‚¹æ•°
        PlayerData player = Database::instance().getPlayer("admin");
        updatePointsUI(player.totalPoints);
    }
}
```

---

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### 1. å•ä¾‹æ¨¡å¼

```cpp
Database& db = Database::instance(); // å…¨å±€å”¯ä¸€å®ä¾‹
```

### 2. äº‹åŠ¡ä¿è¯

`claimAchievementReward()` ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§ï¼š
```cpp
db_.transaction();
// 1. æ›´æ–°æˆå°±çŠ¶æ€
// 2. å¢åŠ ç©å®¶ç‚¹æ•°
db_.commit(); // æˆ– db_.rollback()
```

### 3. æ—¶é—´æ ¼å¼

æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ **ISO 8601** æ ¼å¼ï¼š
```cpp
QString now = QDateTime::currentDateTime().toString(Qt::ISODate);
// ä¾‹å¦‚: "2025-12-14T12:30:45"
```

### 4. é”™è¯¯å¤„ç†

æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æœ‰é”™è¯¯æ—¥å¿—ï¼š
```cpp
if (!query.exec()) {
    qCritical() << "Failed to XXX:" << query.lastError().text();
    return false;
}
```

---

## ğŸ“ å¾…å®Œå–„åŠŸèƒ½

### 1. æˆå°±åˆå§‹åŒ–

**å½“å‰çŠ¶æ€**ï¼š`initializeAchievements()` æ˜¯å ä½å®ç°

**è®¡åˆ’**ï¼š
```cpp
bool Database::initializeAchievements(const QString& playerId)
{
    // ä»AchievementManagerè·å–æ‰€æœ‰æˆå°±å®šä¹‰
    const auto& allAchievements = AchievementManager::instance()
        .getAllAchievementDefinitions();
    
    QSqlQuery query(db_);
    for (const auto& achievementDef : allAchievements) {
        query.prepare(R"(
            INSERT OR IGNORE INTO achievement_progress 
            (player_id, achievement_id, current_value, target_value, state)
            VALUES (?, ?, 0, ?, 0)
        )");
        query.addBindValue(playerId);
        query.addBindValue(achievementDef.id);
        query.addBindValue(achievementDef.targetValue);
        
        if (!query.exec()) {
            return false;
        }
    }
    return true;
}
```

### 2. ä¼šè¯çº§ç©å®¶IDç”Ÿæˆ

**å½“å‰**ï¼šå›ºå®šä½¿ç”¨ `"admin"`

**è®¡åˆ’**ï¼š
```cpp
QString generateSessionPlayerId() {
    QUuid uuid = QUuid::createUuid();
    return "player_" + uuid.toString(QUuid::WithoutBraces).left(8);
}

// æ¸¸æˆå¯åŠ¨æ—¶ï¼š
QString playerId = generateSessionPlayerId();
Database::instance().createPlayer(playerId, "Guest");
Database::instance().setCurrentPlayerId(playerId);
```

### 3. æ•°æ®è¿ç§»å’Œå¤‡ä»½

- å¯¼å‡ºç©å®¶æ•°æ®åˆ°JSON
- ä»JSONæ¢å¤ç©å®¶æ•°æ®
- æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†ï¼ˆALTER TABLEï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```cpp
// æµ‹è¯•ç©å®¶åˆ›å»º
TEST(DatabaseTest, CreatePlayer) {
    Database::instance().initialize(":memory:"); // å†…å­˜æ•°æ®åº“
    bool success = Database::instance().createPlayer("test_player", "Tester");
    ASSERT_TRUE(success);
    
    PlayerData player = Database::instance().getPlayer("test_player");
    ASSERT_EQ(player.username, "Tester");
    ASSERT_EQ(player.totalPoints, 0);
}
```

### 2. é›†æˆæµ‹è¯•

- å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•ï¼ˆæ¸¸æˆâ†’æˆå°±â†’å¥–åŠ±ï¼‰
- å¹¶å‘æµ‹è¯•ï¼ˆå¤šçº¿ç¨‹è®¿é—®ï¼‰
- æ•°æ®ä¸€è‡´æ€§æµ‹è¯•ï¼ˆäº‹åŠ¡å›æ»šï¼‰

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `src/data/Database.h` - æ•°æ®åº“æ¥å£å®šä¹‰
- `src/data/Database.cpp` - æ•°æ®åº“å®ç°
- `src/achievement/AchievementDef.h` - æˆå°±å®šä¹‰ç»“æ„
- `src/achievement/AchievementManager.h` - æˆå°±ç®¡ç†å™¨ï¼ˆå¾…å®Œå–„ï¼‰
- `fruitcrush.db` - SQLiteæ•°æ®åº“æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰

---

## âœ… æ€»ç»“

æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿå·²å®Œæ•´å®ç°ï¼š
- âœ… ç©å®¶æ•°æ®ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ç‚¹æ•°ï¼‰
- âœ… æˆå°±è¿›åº¦è·Ÿè¸ªï¼ˆLOCKED â†’ COMPLETED â†’ CLAIMEDï¼‰
- âœ… æ¸¸æˆè®°å½•ä¿å­˜å’ŒæŸ¥è¯¢
- âœ… ç»Ÿè®¡æŸ¥è¯¢ï¼ˆæ€»å±€æ•°ã€æœ€é«˜åˆ†ã€æˆå°±æ•°ï¼‰
- âœ… äº‹åŠ¡ä¿è¯ï¼ˆé¢†å–å¥–åŠ±çš„åŸå­æ€§ï¼‰
- âœ… ç´¢å¼•ä¼˜åŒ–ï¼ˆæŸ¥è¯¢æ€§èƒ½ï¼‰

**ä¸‹ä¸€æ­¥**ï¼š
1. å®Œå–„ `AchievementManager`ï¼Œå®ç°æˆå°±å®šä¹‰å’Œç›‘å¬ç³»ç»Ÿ
2. é›†æˆåˆ°æ¸¸æˆæµç¨‹ä¸­ï¼ˆæ¸¸æˆç»“æŸæ—¶ä¿å­˜è®°å½•ã€è§¦å‘æˆå°±æ£€æµ‹ï¼‰
3. å®ç°ä¼šè¯çº§ç©å®¶IDç”Ÿæˆï¼ˆå¯é€‰ï¼‰
