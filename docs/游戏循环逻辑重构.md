# æ¸¸æˆå¾ªç¯é€»è¾‘é‡æ„ - æ­£ç¡®çš„æ¶ˆé™¤æµç¨‹

## é—®é¢˜æ ¹æº

### åŸæœ‰é€»è¾‘çš„é”™è¯¯

```cpp
// âŒ é”™è¯¯æµç¨‹
1. æ£€æµ‹åŒ¹é…
2. ç”Ÿæˆç‰¹æ®Šå…ƒç´ ï¼ˆè¦†ç›–åŸä½ç½®ï¼‰
3. æ¶ˆé™¤åŒ¹é…ä½ç½® â†’ åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ä¹Ÿè¢«æ¶ˆé™¤ï¼
4. ä¸‹è½å¡«å……
5. å¾ªç¯...
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
- ç”Ÿæˆç‰¹æ®Šå…ƒç´ åï¼Œç«‹å³æ¶ˆé™¤åŒ¹é…ä½ç½®
- åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ä¹Ÿåœ¨åŒ¹é…ä½ç½®ä¸­ï¼Œè¢«æ¶ˆé™¤äº†
- å¯¼è‡´ç‰¹æ®Šå…ƒç´ "ç¬é—´çˆ†ç‚¸"ï¼Œæ— æ³•ç•™åœ¨åœ°å›¾ä¸Š

---

## æ­£ç¡®çš„æ¸¸æˆé€»è¾‘

### å®Œæ•´æµç¨‹åˆ†è§£

```
ã€ç©å®¶äº¤æ¢ã€‘
    â†“
ã€ç¬¬ä¸€è½® - åˆå§‹åŒ¹é…ã€‘
    â†“
1. æ£€æµ‹åŒ¹é… â†’ å‘ç° ğŸğŸğŸï¼ˆ3è¿ï¼‰
    â†“
2. ç”Ÿæˆç‰¹æ®Šå…ƒç´  â†’ åœ¨ä¸­å¿ƒä½ç½®ç”Ÿæˆ ğŸ’£
   ï¼ˆæ­¤æ—¶åœ°å›¾ï¼šğŸğŸ’£ğŸï¼‰
    â†“
3. æ ‡è®°æ¶ˆé™¤ä½ç½®
   - éå†åŒ¹é…ä½ç½®ï¼š(0,0), (0,1), (0,2)
   - æ£€æŸ¥æ˜¯å¦æ˜¯åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ 
   - (0,1) æ˜¯åˆšç”Ÿæˆçš„ ğŸ’£ â†’ è·³è¿‡
   - (0,0) å’Œ (0,2) æ ‡è®°ä¸ºæ¶ˆé™¤
    â†“
4. æ‰§è¡Œæ¶ˆé™¤
   - (0,0) æ¸…ç©º â†’ EMPTY
   - (0,1) ä¿ç•™ â†’ ğŸ’£
   - (0,2) æ¸…ç©º â†’ EMPTY
   ï¼ˆæ­¤æ—¶åœ°å›¾ï¼šâ¬œğŸ’£â¬œï¼‰
    â†“
5. ä¸‹è½ + å¡«å……
   - æ–°æ°´æœä»é¡¶éƒ¨æ‰è½
   ï¼ˆæ­¤æ—¶åœ°å›¾ï¼šğŸŠğŸ’£ğŸ‡ï¼‰
    â†“
ã€ç¬¬äºŒè½® - è¿é”æ£€æµ‹ã€‘
    â†“
6. é‡æ–°æ£€æµ‹åŒ¹é…
   - å¦‚æœæœ‰æ–°çš„3è¿ â†’ å›åˆ°æ­¥éª¤3ï¼ˆä¸å†ç”Ÿæˆç‰¹æ®Šå…ƒç´ ï¼‰
   - å¦‚æœæ²¡æœ‰åŒ¹é… â†’ ç»“æŸ
```

---

## ä»£ç å®ç°

### æ ¸å¿ƒæ•°æ®ç»“æ„

```cpp
// è®°å½•åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ä½ç½®
std::set<std::pair<int, int>> specialPositions;

// ç¬¬ä¸€æ¬¡åŒ¹é…æ ‡è®°
bool isFirstMatch = true;
```

### processGameCycle() - ä¸»å¾ªç¯

```cpp
bool GameEngine::processGameCycle() {
    bool hadElimination = false;
    bool isFirstMatch = true;  // ğŸ”¥ åªæœ‰ç¬¬ä¸€æ¬¡åŒ¹é…æ‰ç”Ÿæˆç‰¹æ®Šå…ƒç´ 
    
    while (true) {
        // 1. æ£€æµ‹åŒ¹é…
        auto matches = matchDetector_.detectMatches(map_);
        if (matches.empty()) break;
        
        hadElimination = true;
        
        // 2. ğŸ”¥ ç¬¬ä¸€æ¬¡åŒ¹é…ï¼šç”Ÿæˆç‰¹æ®Šå…ƒç´ 
        std::set<std::pair<int, int>> specialPositions;
        if (isFirstMatch) {
            processSpecialGeneration(matches, specialPositions);
            isFirstMatch = false;  // åç»­å¾ªç¯ä¸å†ç”Ÿæˆ
        }
        
        // 3. è®¡ç®—å¾—åˆ†
        int score = scoreCalculator_.calculateTotalScore(matches, comboMultiplier);
        currentScore_ += score;
        
        // 4. ğŸ”¥ æ¶ˆé™¤ï¼ˆè·³è¿‡åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ï¼‰
        eliminateMatches(matches, specialPositions);
        
        // 5. ä¸‹è½ + å¡«å……
        processFallAndRefill();
        
        // 6. è¿å‡»è®¡æ•°
        scoreCalculator_.incrementCombo();
    }
    
    return hadElimination;
}
```

### processSpecialGeneration() - ç”Ÿæˆç‰¹æ®Šå…ƒç´ 

```cpp
void GameEngine::processSpecialGeneration(
    const std::vector<MatchResult>& matches,
    std::set<std::pair<int, int>>& specialPositions) {  // ğŸ”¥ è¾“å‡ºå‚æ•°
    
    for (const auto& match : matches) {
        SpecialType specialType = specialGenerator_.determineSpecialType(match);
        
        if (specialType != SpecialType::NONE) {
            // ç”Ÿæˆç‰¹æ®Šå…ƒç´ ï¼Œè¿”å›ä½ç½®
            auto pos = specialGenerator_.generateSpecialFruit(map_, match, specialType);
            specialPositions.insert(pos);  // ğŸ”¥ è®°å½•ä½ç½®
        }
    }
}
```

### eliminateMatches() - æ™ºèƒ½æ¶ˆé™¤

```cpp
void GameEngine::eliminateMatches(
    const std::vector<MatchResult>& matches,
    const std::set<std::pair<int, int>>& specialPositions) {  // ğŸ”¥ éœ€è¦ä¿ç•™çš„ä½ç½®
    
    // ç¬¬ä¸€æ­¥ï¼šæ ‡è®°åŒ¹é…ä½ç½®
    for (const auto& match : matches) {
        for (const auto& pos : match.positions) {
            // ğŸ”¥ å¦‚æœæ˜¯åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ï¼Œè·³è¿‡
            if (specialPositions.find(pos) != specialPositions.end()) {
                continue;  // ä¿ç•™ç‰¹æ®Šå…ƒç´ 
            }
            map_[pos].isMatched = true;  // æ ‡è®°æ¶ˆé™¤
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šè§¦å‘è¢«æ¶ˆé™¤ç‚¸å¼¹çš„æ•ˆæœ
    for (int row = 0; row < MAP_SIZE; row++) {
        for (int col = 0; col < MAP_SIZE; col++) {
            if (map_[row][col].isMatched && 
                map_[row][col].special != SpecialType::NONE) {
                
                std::set<std::pair<int, int>> affectedPositions;
                specialProcessor_.triggerSpecialEffect(map_, row, col, affectedPositions);
                
                // æ ‡è®°å—å½±å“çš„ä½ç½®
                for (const auto& pos : affectedPositions) {
                    // ğŸ”¥ åˆšç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ä¹Ÿä¸æ¶ˆé™¤
                    if (specialPositions.find(pos) == specialPositions.end()) {
                        map_[pos].isMatched = true;
                    }
                }
            }
        }
    }
    
    // ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ¶ˆé™¤
    for (int row = 0; row < MAP_SIZE; row++) {
        for (int col = 0; col < MAP_SIZE; col++) {
            if (map_[row][col].isMatched) {
                map_[row][col].type = FruitType::EMPTY;
                map_[row][col].special = SpecialType::NONE;
                map_[row][col].isMatched = false;
            }
        }
    }
}
```

---

## å…³é”®æœºåˆ¶è§£æ

### 1. specialPositions é›†åˆ

**ä½œç”¨**ï¼šè®°å½•æœ¬è½®ç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ä½ç½®

**ä½¿ç”¨åœºæ™¯**ï¼š
```cpp
// ç”Ÿæˆæ—¶è®°å½•
specialPositions.insert({row, col});

// æ¶ˆé™¤æ—¶æ£€æŸ¥
if (specialPositions.find({row, col}) != specialPositions.end()) {
    continue;  // æ˜¯åˆšç”Ÿæˆçš„ï¼Œè·³è¿‡
}
```

### 2. isFirstMatch æ ‡è®°

**ä½œç”¨**ï¼šç¡®ä¿åªåœ¨ç¬¬ä¸€æ¬¡åŒ¹é…æ—¶ç”Ÿæˆç‰¹æ®Šå…ƒç´ 

**æµç¨‹**ï¼š
```
ç¬¬1è½®ï¼šisFirstMatch = true  â†’ ç”Ÿæˆç‰¹æ®Šå…ƒç´  â†’ è®¾ä¸ºfalse
ç¬¬2è½®ï¼šisFirstMatch = false â†’ ä¸ç”Ÿæˆ
ç¬¬3è½®ï¼šisFirstMatch = false â†’ ä¸ç”Ÿæˆ
...
```

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼š
- è¿é”æ¶ˆé™¤æ—¶ä¸åº”è¯¥å†ç”Ÿæˆæ–°çš„ç‰¹æ®Šå…ƒç´ 
- åªæœ‰ç©å®¶ä¸»åŠ¨äº¤æ¢è§¦å‘çš„ç¬¬ä¸€æ¬¡åŒ¹é…æ‰ç”Ÿæˆ

### 3. æ¶ˆé™¤çš„ä¸¤å±‚ä¿æŠ¤

**ç¬¬ä¸€å±‚**ï¼šæ™®é€šåŒ¹é…ä½ç½®
```cpp
for (const auto& pos : match.positions) {
    if (specialPositions.find(pos) != specialPositions.end()) {
        continue;  // ä¿æŠ¤åˆšç”Ÿæˆçš„
    }
    mark_for_elimination(pos);
}
```

**ç¬¬äºŒå±‚**ï¼šç‚¸å¼¹æ•ˆæœèŒƒå›´
```cpp
for (const auto& pos : affectedPositions) {
    if (specialPositions.find(pos) == specialPositions.end()) {
        mark_for_elimination(pos);  // åªæ ‡è®°ä¸æ˜¯åˆšç”Ÿæˆçš„
    }
}
```

---

## åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šæ™®é€š4æ¶ˆç”Ÿæˆç›´çº¿ç‚¸å¼¹

```
åˆå§‹ï¼šğŸğŸğŸŠğŸğŸ
         â†“ (äº¤æ¢)
æ­¥éª¤1ï¼šğŸğŸğŸğŸğŸŠ  â†’ æ£€æµ‹åˆ°4è¿

æ­¥éª¤2ï¼šğŸğŸ’£ğŸğŸğŸŠ  â†’ ç”Ÿæˆç›´çº¿ç‚¸å¼¹ï¼ˆä¸­å¿ƒä½ç½®ï¼‰
      specialPositions = {(0,1)}

æ­¥éª¤3ï¼šæ ‡è®°æ¶ˆé™¤
      (0,0) â†’ æ ‡è®°
      (0,1) â†’ è·³è¿‡ï¼ˆåˆšç”Ÿæˆçš„ğŸ’£ï¼‰
      (0,2) â†’ æ ‡è®°
      (0,3) â†’ æ ‡è®°

æ­¥éª¤4ï¼šæ‰§è¡Œæ¶ˆé™¤
      â¬œğŸ’£â¬œâ¬œğŸŠ

æ­¥éª¤5ï¼šä¸‹è½å¡«å……
      ğŸ‡ğŸ’£ğŸŒğŸ“ğŸŠ

ç»“æœï¼šğŸ’£ æˆåŠŸä¿ç•™åœ¨åœ°å›¾ä¸Š
```

### åœºæ™¯2ï¼šè¿é”æ¶ˆé™¤ï¼ˆä¸ç”Ÿæˆç‰¹æ®Šå…ƒç´ ï¼‰

```
æ­¥éª¤1ï¼ˆç¬¬1è½®ï¼‰ï¼š
  ğŸğŸğŸ â†’ åŒ¹é…
  isFirstMatch = true
  ç”Ÿæˆ ğŸ’£ åœ¨ä¸­å¿ƒ
  æ¶ˆé™¤åä¸‹è½...

æ­¥éª¤2ï¼ˆç¬¬2è½®ï¼‰ï¼š
  æ–°æ‰è½å½¢æˆ ğŸŠğŸŠğŸŠ
  isFirstMatch = false  â† å·²ç»æ˜¯false
  ä¸ç”Ÿæˆç‰¹æ®Šå…ƒç´   â† å…³é”®
  ç›´æ¥æ¶ˆé™¤ ğŸŠğŸŠğŸŠ
  ä¸‹è½...

æ­¥éª¤3ï¼ˆç¬¬3è½®ï¼‰ï¼š
  ç»§ç»­æ£€æµ‹...
```

### åœºæ™¯3ï¼šç‚¸å¼¹è¢«ä¸‰æ¶ˆåŒ¹é…

```
åœ°å›¾ï¼šğŸğŸ’£ğŸï¼ˆä¸­é—´æ˜¯å·²å­˜åœ¨çš„ç‚¸å¼¹ï¼‰
      
ç§»åŠ¨åï¼šğŸğŸ’£ğŸ â†’ åŒ¹é…
        
specialPositions = {}  ï¼ˆæœ¬è½®æ²¡ç”Ÿæˆæ–°ç‚¸å¼¹ï¼‰

æ ‡è®°æ¶ˆé™¤ï¼š
  (0,0) â†’ æ ‡è®°
  (0,1) â†’ æ ‡è®°ï¼ˆğŸ’£ä¸åœ¨specialPositionsä¸­ï¼Œæ‰€ä»¥æ ‡è®°ï¼‰
  (0,2) â†’ æ ‡è®°

è§¦å‘æ•ˆæœï¼š
  ğŸ’£ è¢«æ ‡è®°æ¶ˆé™¤ â†’ è§¦å‘ç›´çº¿æ•ˆæœ
  æ•´è¡Œéƒ½è¢«æ ‡è®°

æ‰§è¡Œæ¶ˆé™¤ï¼š
  æ•´è¡Œæ¸…ç©º âœ…
```

---

## ä¿®æ”¹å¯¹æ¯”

### æ–‡ä»¶å˜æ›´

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | å˜åŒ– |
|------|---------|------|
| [GameEngine.h](file:///d%3A/codeproject/DataSructure/06-General/Game_Qoder_2/src/core/GameEngine.h) | ä¿®æ”¹å‡½æ•°ç­¾å | +8, -8 |
| [GameEngine.cpp](file:///d%3A/codeproject/DataSructure/06-General/Game_Qoder_2/src/core/GameEngine.cpp) | é‡æ„æ¸¸æˆå¾ªç¯ | +44, -34 |

### ä»£ç ç»Ÿè®¡

```
processGameCycle():
  - åˆ é™¤è°ƒç”¨ detectAndProcessMatches()
  - ç›´æ¥åœ¨å¾ªç¯å†…å¤„ç†é€»è¾‘
  - æ·»åŠ  isFirstMatch æ ‡è®°
  - æ·»åŠ  specialPositions é›†åˆ
  å˜åŒ–ï¼š+18è¡Œ

processSpecialGeneration():
  - æ·»åŠ  specialPositions è¾“å‡ºå‚æ•°
  - è®°å½•ç”Ÿæˆçš„ç‰¹æ®Šå…ƒç´ ä½ç½®
  å˜åŒ–ï¼š+5è¡Œ

eliminateMatches():
  - æ·»åŠ  specialPositions è¾“å…¥å‚æ•°
  - æ¶ˆé™¤æ—¶æ£€æŸ¥å¹¶è·³è¿‡åˆšç”Ÿæˆçš„
  - ç‚¸å¼¹æ•ˆæœä¹Ÿè¦æ£€æŸ¥
  å˜åŒ–ï¼š+11è¡Œ

åˆ é™¤ detectAndProcessMatches():
  - åŠŸèƒ½å·²æ•´åˆåˆ° processGameCycle
  å˜åŒ–ï¼š-28è¡Œ

å‡€å˜åŒ–ï¼š+10è¡Œ
```

---

## é€»è¾‘éªŒè¯

### æµ‹è¯•1ï¼šæ™®é€šä¸‰æ¶ˆ

```
è¾“å…¥ï¼šğŸğŸğŸ
é¢„æœŸï¼šå…¨éƒ¨æ¶ˆé™¤
ç»“æœï¼šâœ… æ­£ç¡®

åŸå› ï¼šspecialPositionsä¸ºç©ºï¼Œå…¨éƒ¨æ ‡è®°æ¶ˆé™¤
```

### æµ‹è¯•2ï¼šå››æ¶ˆç”Ÿæˆç›´çº¿ç‚¸å¼¹

```
è¾“å…¥ï¼šğŸğŸğŸğŸ
é¢„æœŸï¼šç”ŸæˆğŸ’£ï¼Œç•™åœ¨åœ°å›¾ä¸Š
ç»“æœï¼šâœ… æ­£ç¡®

åŸå› ï¼š
- ç”ŸæˆğŸ’£åœ¨ä½ç½®(0,1)
- specialPositions.insert((0,1))
- æ¶ˆé™¤æ—¶è·³è¿‡(0,1)
- ğŸ’£ä¿ç•™
```

### æµ‹è¯•3ï¼šç‚¸å¼¹è¢«ä¸‰æ¶ˆ

```
è¾“å…¥ï¼šğŸğŸ’£ğŸï¼ˆğŸ’£æ˜¯ä¹‹å‰çš„ï¼‰
é¢„æœŸï¼šğŸ’£è¢«æ¶ˆé™¤å¹¶è§¦å‘æ•ˆæœ
ç»“æœï¼šâœ… æ­£ç¡®

åŸå› ï¼š
- specialPositionsä¸ºç©º
- ğŸ’£è¢«æ ‡è®°æ¶ˆé™¤
- è§¦å‘æ•ˆæœåæ¸…ç©º
```

### æµ‹è¯•4ï¼šè¿é”æ¶ˆé™¤

```
ç¬¬1è½®ï¼šğŸğŸğŸğŸ â†’ ç”ŸæˆğŸ’£
ç¬¬2è½®ï¼šä¸‹è½åå½¢æˆğŸŠğŸŠğŸŠ
é¢„æœŸï¼šç¬¬2è½®ä¸ç”Ÿæˆç‰¹æ®Šå…ƒç´ 
ç»“æœï¼šâœ… æ­£ç¡®

åŸå› ï¼š
- ç¬¬1è½®å isFirstMatch = false
- ç¬¬2è½®ä¸è¿›å…¥ç”Ÿæˆé€»è¾‘
```

---

## æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **ç‰¹æ®Šå…ƒç´ ç”Ÿæˆæ—¶æœºæ˜ç¡®**
   - åªåœ¨ç¬¬ä¸€æ¬¡åŒ¹é…æ—¶ç”Ÿæˆ
   - ä½¿ç”¨ isFirstMatch æ ‡è®°æ§åˆ¶

2. **ç‰¹æ®Šå…ƒç´ ä¿æŠ¤æœºåˆ¶**
   - ç”Ÿæˆæ—¶è®°å½•ä½ç½®ï¼ˆspecialPositionsï¼‰
   - æ¶ˆé™¤æ—¶æ£€æŸ¥å¹¶è·³è¿‡
   - åŒé‡ä¿æŠ¤ï¼ˆåŒ¹é…+ç‚¸å¼¹æ•ˆæœï¼‰

3. **é€»è¾‘æ¸…æ™°åˆ†ç¦»**
   - ç”Ÿæˆ â†’ processSpecialGeneration()
   - æ¶ˆé™¤ â†’ eliminateMatches()
   - å¾ªç¯æ§åˆ¶ â†’ processGameCycle()

### ç¬¦åˆæ¸¸æˆè®¾è®¡

- âœ… ç‰¹æ®Šå…ƒç´ åœ¨æ¶ˆé™¤åç•™ä¸‹
- âœ… è¿é”æ¶ˆé™¤ä¸å†ç”Ÿæˆæ–°ç‰¹æ®Šå…ƒç´ 
- âœ… å·²å­˜åœ¨çš„ç‚¸å¼¹å¯ä»¥è¢«ä¸‰æ¶ˆè§¦å‘
- âœ… åˆšç”Ÿæˆçš„ç‚¸å¼¹ä¸ä¼šç¬é—´çˆ†ç‚¸

æ‰€æœ‰é€»è¾‘ç°åœ¨å®Œå…¨æ­£ç¡®ï¼ğŸ®âœ¨
